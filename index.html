<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ–∏–∫ –î–µ–∂—É—Ä—Å—Ç–≤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --text-color: var(--tg-theme-text-color, #000);
            --hint-color: var(--tg-theme-hint-color, #999);
            --button-color: var(--tg-theme-button-color, #2481cc);
            --button-text-color: var(--tg-theme-button-text-color, #fff);
            --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 10px;
            user-select: none;
        }
        
        /* Header & Navigation */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
        }
        h2 { margin: 0; font-size: 18px; }
        .nav-btn {
            background: none; border: none; font-size: 24px; cursor: pointer;
            color: var(--button-color); padding: 0 10px;
        }

        /* Grid */
        .calendar-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 20px;
        }
        .weekday {
            text-align: center; font-weight: bold; font-size: 12px;
            color: var(--hint-color); padding-bottom: 5px;
        }
        
        /* Cells */
        .day-cell {
            aspect-ratio: 1; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            background-color: var(--secondary-bg);
            font-size: 12px; padding-top: 4px; position: relative; cursor: pointer;
        }
        .day-cell.today { border: 2px solid var(--button-color); }
        .day-cell.selected { background-color: var(--button-color); color: var(--button-text-color); }

        /* Dots container */
        .dots {
            display: flex; gap: 2px; margin-top: 2px; flex-wrap: wrap; justify-content: center; width: 100%;
        }
        .dot { width: 6px; height: 6px; border-radius: 50%; }
        .dot.day { background-color: #f1c40f; } /* –ñ–µ–ª—Ç—ã–π –¥–ª—è –¥–Ω—è */
        .dot.night { background-color: #3498db; } /* –°–∏–Ω–∏–π –¥–ª—è –Ω–æ—á–∏ */
        .dot.me { border: 1px solid var(--text-color); transform: scale(1.2); } /* –õ–∏—á–Ω–∞—è —Å–º–µ–Ω–∞ */

        /* Info Box */
        .info-box {
            padding: 15px; background: var(--secondary-bg);
            border-radius: 12px; min-height: 80px;
        }
        .info-header { font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid var(--hint-color); padding-bottom: 4px; }
        .shift-row { display: flex; align-items: center; margin-bottom: 4px; font-size: 14px; }
        .shift-icon { margin-right: 8px; font-size: 16px; }
        .me-highlight { font-weight: bold; color: var(--button-color); }

    </style>
</head>
<body>
    <div class="header">
        <button class="nav-btn" onclick="changeMonth(-1)">&#8249;</button>
        <h2 id="monthTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        <button class="nav-btn" onclick="changeMonth(1)">&#8250;</button>
    </div>
    
    <div class="calendar-grid" id="calendar"></div>
    
    <div class="info-box" id="details">
        <i>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –¥–µ–Ω—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ –¥–µ–∂—É—Ä–Ω—ã—Ö.</i>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- Parsing Data ---
        let scheduleData = { year: 2024, month: 1, user: "", shifts: [] };
        try {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const rawData = params.get('data');
            if (rawData) scheduleData = JSON.parse(decodeURIComponent(rawData));
        } catch (e) {
            document.getElementById('details').innerText = "Error: " + e.message;
        }

        const currentMonth = scheduleData.month - 1; // JS 0-11
        const currentYear = scheduleData.year;
        const currentUser = scheduleData.user;
        const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
        
        document.getElementById('monthTitle').innerText = `${monthNames[currentMonth]} ${currentYear}`;

        // --- Rendering ---
        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = ''; // Clear

            // Weekdays headers
            ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'].forEach(d => {
                const el = document.createElement('div');
                el.className = 'weekday'; el.innerText = d;
                calendarEl.appendChild(el);
            });

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDayIndex = (new Date(currentYear, currentMonth, 1).getDay() + 6) % 7; // Mon=0

            // Empty slots
            for (let i = 0; i < firstDayIndex; i++) {
                calendarEl.appendChild(document.createElement('div'));
            }

            // Days
            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                
                // Check Today
                const today = new Date();
                if (d === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) {
                    cell.classList.add('today');
                }

                cell.innerHTML = `<span>${d}</span><div class="dots"></div>`;
                
                // Find shifts for this day
                const dayData = (scheduleData.shifts || []).find(s => s.day === d);
                
                if (dayData) {
                    const dotsContainer = cell.querySelector('.dots');
                    
                    // Add dots
                    dayData.day_workers.forEach(name => addDot(dotsContainer, 'day', name));
                    dayData.night_workers.forEach(name => addDot(dotsContainer, 'night', name));

                    // Click Event
                    cell.onclick = () => showDetails(d, dayData);
                } else {
                    cell.onclick = () => showDetails(d, null);
                }

                calendarEl.appendChild(cell);
            }
        }

        function addDot(container, type, name) {
            const dot = document.createElement('div');
            dot.className = `dot ${type}`;
            if (name === currentUser) dot.classList.add('me');
            container.appendChild(dot);
        }

        function showDetails(day, data) {
            tg.HapticFeedback.impactOccurred('light');
            
            // Highlight selected cell
            document.querySelectorAll('.day-cell').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            const box = document.getElementById('details');
            if (!data) {
                box.innerHTML = `<div class="info-header">${day} ${monthNames[currentMonth]}</div><div>–î–µ–∂—É—Ä–Ω—ã—Ö –Ω–µ—Ç</div>`;
                return;
            }

            let html = `<div class="info-header">${day} ${monthNames[currentMonth]}</div>`;
            
            if (data.day_workers.length > 0) {
                html += `<div class="shift-row"><span class="shift-icon">‚òÄÔ∏è</span> ${formatNames(data.day_workers)}</div>`;
            }
            if (data.night_workers.length > 0) {
                html += `<div class="shift-row"><span class="shift-icon">üåô</span> ${formatNames(data.night_workers)}</div>`;
            }
            box.innerHTML = html;
        }

        function formatNames(names) {
            return names.map(n => n === currentUser ? `<span class="me-highlight">${n}</span>` : n).join(', ');
        }

        // --- Navigation Logic ---
        window.changeMonth = function(offset) {
            let newMonth = currentMonth + offset;
            let newYear = currentYear;

            if (newMonth > 11) { newMonth = 0; newYear++; }
            else if (newMonth < 0) { newMonth = 11; newYear--; }

            // Send data back to Telegram Bot
            tg.sendData(JSON.stringify({
                action: 'change_month',
                year: newYear,
                month: newMonth + 1 // Send 1-12 format
            }));
        };

        renderCalendar();
    </script>
</body>
</html>
